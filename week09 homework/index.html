<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Noto 1km Mesh Population Map</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
	<style>
		body {
			margin: 0;
			padding: 0;
		}
		#map {
			width: 100%;
			height: 100vh;
		}
		button {
			margin: 2px 0;
			width: auto;
		}
	</style>
</head>
<body>

	<!-- ã‚¿ã‚¤ãƒˆãƒ« -->
	<div style="position:absolute; top:10px; left:10px; z-index:1; background:white; padding:10px; border-radius:8px;">
		<h2 style="margin:0;">èƒ½ç™»å³¶1kmãƒ¡ãƒƒã‚·ãƒ¥äººå£åˆ†å¸ƒå›³</h2>
		<p style="margin:0;">å‡ºå…¸ï¼šçµ±è¨ˆãƒ¡ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿</p>
	</div>

	<!-- è¡¨ç¤ºè¨­å®šãƒ‘ãƒãƒ«ï¼ˆäººå£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼‹ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆï¼‰ -->
	<div style="position:absolute; top:100px; left:10px; z-index:1; background:white; padding:10px; border-radius:8px; font-size:14px;">
		<button onclick="toggleDisplayPanel()"> ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é–‹ã</button>
		<div id="display-panel" style="display:none; margin-top:8px;">

			<!-- äººå£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
			<b>ğŸ“Œ äººå£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</b><br>
			<button onclick="filterByRange(0, 500)">0ã€œ500äºº</button>
			<button onclick="filterByRange(500, 1000)">500ã€œ1000äºº</button>
			<button onclick="filterByRange(1000, 1500)">1000ã€œ1500äºº</button>
			<button onclick="filterByRange(1500, 2000)">1500ã€œ2000äºº</button>
			<button onclick="filterByRange(2000, 999999)">2000äººä»¥ä¸Š</button>
			<button onclick="resetFilter()">ã™ã¹ã¦è¡¨ç¤º</button>

			<hr>

			<!-- ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ -->
			<b>ğŸ—ºï¸ ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—</b><br>
			<button onclick="switchBaseMap('dark')">ğŸŒŒ ãƒ€ãƒ¼ã‚¯</button>
			<button onclick="switchBaseMap('light')">ğŸ—ºï¸ ãƒ©ã‚¤ãƒˆ</button>
		</div>
	</div>

	<!-- å‡¡ä¾‹ -->
	<div style="position:absolute; bottom:20px; left:10px; background:white; padding:10px; font-size:12px; z-index:1; border-radius:6px;">
		<b>äººå£ï¼ˆäººï¼‰</b><br>
		<span style="background:#015fb7; padding:2px 10px;"></span> 0ã€œ500<br>
		<span style="background:#ffff02; padding:2px 10px;"></span> 500ã€œ1000<br>
		<span style="background:#d97f00; padding:2px 10px;"></span> 1000ã€œ1500<br>
		<span style="background:#ca06dc; padding:2px 10px;"></span> 1500ã€œ2000<br>
		<span style="background:#ff0000; padding:2px 10px;"></span> 2000ä»¥ä¸Š
	</div>

	<div id="map"></div>
	<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
	<script>
		let currentStyle = 'dark';

		const map = new maplibregl.Map({
			container: 'map',
			style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
			center: [136.97465968589398, 37.04619165311153],
			zoom: 9
		});

		map.on('load', () => {
			addPopulationLayer();
		});

		function addPopulationLayer() {
			if (!map.getSource('tokyo')) {
				map.addSource('tokyo', {
					type: 'geojson',
					data: 'Noto_population.geojson'
				});
			}
			if (!map.getLayer('population-layer')) {
				map.addLayer({
					id: 'population-layer',
					type: 'fill',
					source: 'tokyo',
					paint: {
						'fill-color': [
							'interpolate',
							['linear'],
							['get', 'T001100001'],
							0, '#015fb7',
							500, '#ffff02',
							1000, '#d97f00',
							1500, '#ca06dc',
							4000, '#ff0000'
						],
						'fill-opacity': 0.75,
						'fill-outline-color': '#ffffff'
					},
					filter: ['>', ['get', 'T001100001'], 0]
				});
			}

			map.on('mousemove', 'population-layer', (e) => {
				const props = e.features[0].properties;
				const population = props['T001100001'];
				if (population === undefined || population <= 0) return;

				const coordinates = e.lngLat;
				document.querySelectorAll('.maplibregl-popup').forEach(el => el.remove());

				new maplibregl.Popup({ closeButton: false })
					.setLngLat(coordinates)
					.setHTML(`<strong>äººå£ï¼š</strong>${population}äºº`)
					.addTo(map);
			});

			map.on('mouseleave', 'population-layer', () => {
				document.querySelectorAll('.maplibregl-popup').forEach(el => el.remove());
			});
		}

		// è¡¨ç¤ºè¨­å®šã®ãƒˆã‚°ãƒ«
		window.toggleDisplayPanel = function () {
			const el = document.getElementById('display-panel');
			el.style.display = (el.style.display === 'none') ? 'block' : 'none';
		};

		// äººå£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
		window.filterByRange = function (min, max) {
			map.setFilter('population-layer', [
				'all',
				['>=', ['get', 'T001100001'], min],
				['<', ['get', 'T001100001'], max]
			]);
		};

		window.resetFilter = function () {
			map.setFilter('population-layer', ['>', ['get', 'T001100001'], 0]);
		};

		// ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ
		window.switchBaseMap = function(styleType) {
			let styleURL;
			if (styleType === 'dark') {
				styleURL = 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json';
			} else if (styleType === 'light') {
				styleURL = 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json';
			}
			currentStyle = styleType;
			map.setStyle(styleURL);
			map.once('styledata', () => {
				addPopulationLayer();
			});
		};
	</script>
</body>
</html>
